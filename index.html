<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Behandlungs-Tracker</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Behandlungs-Tracker f√ºr Katzen - 84 Tage Medikamenten-Therapie">
    <meta name="theme-color" content="#3B82F6">
    <link rel="manifest" href="./manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Behandlung">
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="apple-touch-icon" href="./icons/app-icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/app-icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/app-icon-512.png">
    <meta name="msapplication-TileImage" content="./icons/app-icon-192.png">
    <meta name="msapplication-TileColor" content="#3B82F6">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/health.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .mobile-compact {
                padding: 1rem;
                margin-bottom: 1rem;
            }
            
            .mobile-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 0.75rem;
            }
            
            .mobile-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .mobile-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }

        /* Better touch targets */
        button, input, select, textarea {
            min-height: 44px;
        }
        
        /* PWA install button */
        .install-prompt {
            display: none;
        }
        
        .install-prompt.show {
            display: flex;
        }

        .demo-highlight {
            position: relative;
            z-index: 45;
            transition: all 0.3s ease;
        }

        @keyframes pulse-blue {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }

        .faq-enter {
            transform: translateX(100%);
        }

        .faq-enter-active {
            transform: translateX(0);
            transition: transform 300ms ease-in-out;
        }

        @media (max-width: 640px) {
            .faq-sidebar {
                width: 100vw;
                max-width: none;
            }
        }

        .dismissible-card {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            animation: gentle-pulse 3s infinite;
        }

        .dismissible-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .dismissible-card::after {
            content: "‚ú®";
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .dismissible-card:hover::after {
            opacity: 0.6;
        }

        @keyframes gentle-pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.1);
            }
            50% {
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.05);
            }
        }

        /* Cat Loader Styles */
        .cat-loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        .cat-loader-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .cat {
            position: relative;
            width: 100%;
            max-width: 12em;
            overflow: hidden;
            background-color: #e6dcdc;
            border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .cat::before {
            content: '';
            display: block;
            padding-bottom: 100%;
        }

        .cat:hover > * {
            animation-play-state: paused;
        }

        .cat:active > * {
            animation-play-state: running;
        }

        .cat-img-base {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            animation: rotating 2.79s cubic-bezier(.65, .54, .12, .93) infinite;
        }

        .cat-img-base::before {
            content: '';
            position: absolute;
            width: 50%;
            height: 50%;
            background-size: 200%;
            background-repeat: no-repeat;
            background-image: url('https://images.weserv.nl/?url=i.imgur.com/M1raXX3.png&il');
        }

        .cat__head::before {
            top: 0;
            right: 0;
            background-position: 100% 0%;
            transform-origin: 0% 100%;
            transform: rotate(90deg);
        }

        .cat__tail {
            animation-delay: 0.2s;
        }

        .cat__tail::before {
            left: 0;
            bottom: 0;
            background-position: 0% 100%;
            transform-origin: 100% 0%;
            transform: rotate(-30deg);
        }

        .cat__body {
            animation-delay: 0.1s;
        }

        .cat__body:nth-of-type(2) {
            animation-delay: 0.2s;
        }

        .cat__body::before {
            right: 0;
            bottom: 0;
            background-position: 100% 100%;
            transform-origin: 0% 0%;
        }

        @keyframes rotating {
            from { transform: rotate(720deg); }
            to { transform: none; }
        }

        .loader-title {
            margin-top: 2rem;
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            text-align: center;
            animation: fade-in-up 1s ease-out 0.5s both;
        }

        .loader-subtitle {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6B7280;
            text-align: center;
            animation: fade-in-up 1s ease-out 0.8s both;
        }

        @keyframes fade-in-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 640px) {
            .cat { max-width: 10em; }
            .loader-title { font-size: 1.25rem; }
        }

        .cat-skeleton {
            width: 10em;
            height: 10em;
            position: relative;
            animation: skeleton-pulse 1.5s ease-in-out infinite alternate;
        }

        @keyframes skeleton-pulse {
            0% { opacity: 0.6; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        class PWAInstaller {
          constructor() {
            this.deferredPrompt = null;
            this.setupInstallPrompt();
          }

          setupInstallPrompt() {
            window.addEventListener('beforeinstallprompt', (e) => {
              e.preventDefault();
              this.deferredPrompt = e;
              this.showInstallButton();
            });

            window.addEventListener('appinstalled', () => {
              this.hideInstallButton();
              this.showSuccessMessage();
            });
          }

          async installApp() {
            if (!this.deferredPrompt) {
              this.showManualInstructions();
              return;
            }

            const result = await this.deferredPrompt.prompt();
            this.deferredPrompt = null;

            if (result.outcome === 'accepted') {
              this.hideInstallButton();
            }
          }

          showInstallButton() {
            const btn = document.querySelector('.install-prompt');
            if (btn) btn.classList.add('show');
          }

          hideInstallButton() {
            const btn = document.querySelector('.install-prompt');
            if (btn) btn.classList.remove('show');
          }

          showSuccessMessage() {
            console.log('App installed');
          }

          showManualInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const message = isIOS
              ? 'Teilen-Button ‚Üí "Zum Home-Bildschirm hinzuf√ºgen"'
              : 'Browser-Men√º ‚Üí "App installieren" oder "Zum Startbildschirm hinzuf√ºgen"';

            alert(`App Installation:\n${message}`);
          }
        }

        // Behandlungs-Tracker App
        class TreatmentTracker {
            constructor() {
                this.state = {
                    startDate: localStorage.getItem('treatment-startDate') || '',
                    catWeight: localStorage.getItem('treatment-catWeight') || '',
                    catName: localStorage.getItem('treatment-catName') || '',
                    fipType: localStorage.getItem('treatment-medicationType') || '',
                    concentration: localStorage.getItem('treatment-concentration') || '',
                    customDose: localStorage.getItem('treatment-customDose') || '',
                    reminderTime: localStorage.getItem('treatment-reminderTime') || '19:30',
                    treatmentData: JSON.parse(localStorage.getItem('treatment-progress') || '{}'),
                    diary: JSON.parse(localStorage.getItem('treatment-diary') || '{}'),
                    notificationsEnabled: false,
                    isDemo: false,
                    demoStep: 0,
                    showDemoOverlay: false,
                    demoSteps: [
                        { target: 'cat-name-input', title: 'Katzenname eingeben', text: 'Hier tr√§gst du den Namen deiner Katze ein f√ºr eine pers√∂nliche Behandlung.' },
                        { target: 'weight-input', title: 'Gewicht erfassen', text: 'Das aktuelle Gewicht ist wichtig f√ºr die korrekte Dosisberechnung.' },
                        { target: 'fip-type-select', title: 'Behandlungsart w√§hlen', text: 'Je nach Erkrankungsart unterscheidet sich die Dosierung.' },
                        { target: 'dose-display', title: 'Automatische Berechnung', text: 'Die App berechnet automatisch die richtige Tagesdosis.' },
                        { target: 'reminder-section', title: 'Erinnerungen aktivieren', text: 'Lass dich t√§glich an die Behandlung erinnern.' },
                        { target: 'calendar-grid', title: 'Behandlungskalender', text: 'Hier trackst du jeden Tag die Behandlung √ºber 84 Tage.' },
                        { target: 'progress-bar', title: 'Fortschritt verfolgen', text: 'Sieh deinen Behandlungsfortschritt auf einen Blick.' }
                    ],
                    editingWeight: false,
                    editingDiary: '',
                    showFAQ: false,
                    openFAQ: null,
                    currentTime: new Date(),
                    dismissedCards: {},
                    showLoader: true,
                    loadingComplete: false
                };
                
                this.demoData = {
                    catName: 'Mimi',
                    catWeight: '3.7',
                    fipType: 'ocular',
                    concentration: '16',
                    startDate: new Date().toISOString().split('T')[0],
                    reminderTime: '19:30'
                };

                const img = new Image();
                img.src = 'https://images.weserv.nl/?url=i.imgur.com/M1raXX3.png&il';

                this.init();
            }

            init() {
                this.render();

                setTimeout(() => {
                    this.state.showLoader = false;
                    this.state.loadingComplete = true;
                    this.render();
                }, 2500);

                // Update time every minute
                setInterval(() => {
                    this.state.currentTime = new Date();
                }, 60000);
            }

            calculateDose() {
                if (!this.state.catWeight || !this.state.fipType || !this.state.concentration) return null;
                
                const dosageMap = {
                    'neuro': 10,
                    'ocular': 8,
                    'wet_dry': 6
                };
                
                const dosage = dosageMap[this.state.fipType];
                const rawDose = (parseFloat(this.state.catWeight) * dosage) / parseFloat(this.state.concentration);
                return Math.ceil(rawDose * 10) / 10;
            }

            generateTreatmentDays(start) {
                const days = [];
                const startDay = new Date(start);
                for (let i = 0; i < 84; i++) {
                    const day = new Date(startDay);
                    day.setDate(startDay.getDate() + i);
                    const dayNumber = i + 1;
                    
                    days.push({
                        day: dayNumber,
                        date: day.toISOString().split('T')[0],
                        dateObj: day,
                        completed: this.state.treatmentData[day.toISOString().split('T')[0]] || false,
                        isMilestone: this.getMilestone(dayNumber)
                    });
                }
                return days;
            }

            getMilestone(day) {
                if (day >= 28 && day <= 30) return { type: 'blood1', text: 'Erstes Kontroll-Blutbild', icon: 'ü©∏' };
                if (day >= 54 && day <= 56) return { type: 'blood2', text: 'Zweites Kontroll-Blutbild', icon: 'ü©∏' };
                if (day >= 60 && day <= 70) return { type: 'surgery', text: 'Ggf. weitere Eingriffe', icon: 'üè•' };
                if (day >= 77 && day <= 81) return { type: 'final', text: 'Abschluss-Untersuchung & Therapieende!', icon: 'üéâ' };
                if (day === 84) return { type: 'complete', text: 'Behandlung abgeschlossen!', icon: 'üèÜ' };
                return null;
            }

            startDemo() {
                this.state.isDemo = true;
                this.state.demoStep = 0;
                this.state.showDemoOverlay = true;
                Object.assign(this.state, this.demoData);
                this.render();
                setTimeout(() => this.highlightDemoTarget(), 100);
            }

            nextDemoStep() {
                if (this.state.demoStep < this.state.demoSteps.length - 1) {
                    this.state.demoStep++;
                    this.render();
                    setTimeout(() => this.highlightDemoTarget(), 100);
                } else {
                    this.state.showDemoOverlay = false;
                    this.render();
                }
            }

            prevDemoStep() {
                if (this.state.demoStep > 0) {
                    this.state.demoStep--;
                    this.render();
                    setTimeout(() => this.highlightDemoTarget(), 100);
                }
            }

            exitDemo() {
                this.state.isDemo = false;
                this.state.demoStep = 0;
                this.state.showDemoOverlay = false;
                this.state.catWeight = '';
                this.state.fipType = '';
                this.state.concentration = '';
                this.state.startDate = '';
                this.state.customDose = '';
                this.state.treatmentData = {};
                this.state.diary = {};
                this.render();
            }

            enableNotifications() {
                if ('Notification' in window) {
                    Notification.requestPermission().then((permission) => {
                        this.state.notificationsEnabled = permission === 'granted';
                        this.render();
                        
                        if (permission === 'granted') {
                            const checkReminder = () => {
                                if (!this.state.startDate) return;
                                
                                const now = new Date();
                                const [hours, minutes] = this.state.reminderTime.split(':');
                                const reminderDate = new Date();
                                reminderDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                                
                                const timeDiff = Math.abs(now - reminderDate);
                                if (timeDiff < 60000) {
                                    const today = now.toISOString().split('T')[0];
                                    const treatmentDays = this.generateTreatmentDays(this.state.startDate);
                                    const todayTreatment = treatmentDays.find(day => day.date === today);
                                    
                                    if (todayTreatment && !todayTreatment.completed) {
                                        new Notification(`${this.state.catName ? this.state.catName + ' - ' : ''}Behandlungs-Erinnerung! üíâ`, {
                                            body: `Zeit f√ºr die t√§gliche Medikation (${this.calculateDose()} ml)`
                                        });
                                    }
                                }
                            };
                            
                            setInterval(checkReminder, 60000);
                        }
                    });
                }
            }

            toggleTreatment(date) {
                this.state.treatmentData[date] = !this.state.treatmentData[date];
                this.saveProgress();
                this.render();
            }

            toggleFAQ(index) {
                this.state.openFAQ = this.state.openFAQ === index ? null : index;
                this.render();
            }

            updateDiary(date, note) {
                this.state.diary[date] = note;
                this.saveProgress();
            }

            updateState(key, value) {
                this.state[key] = value;
                
                // Save important settings to localStorage
                const settingsKeys = ['startDate', 'catWeight', 'catName', 'fipType', 'concentration', 'customDose', 'reminderTime'];
                if (settingsKeys.includes(key)) {
                    const storageKey = key === 'fipType' ? 'treatment-medicationType' : `treatment-${key}`;
                    localStorage.setItem(storageKey, value);
                }
                
                this.render();
            }

            saveProgress() {
                localStorage.setItem('treatment-progress', JSON.stringify(this.state.treatmentData));
                localStorage.setItem('treatment-diary', JSON.stringify(this.state.diary));
            }

            formatTimeUntil(milliseconds) {
                if (milliseconds <= 0) return "Zeit ist vorbei";
                const hours = Math.floor(milliseconds / (1000 * 60 * 60));
                const minutes = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
                return `${hours}h ${minutes}m bis ${this.state.reminderTime}`;
            }

            renderFAQ() {
                const faqs = [
                    {
                        question: "Welche Medikamente k√∂nnen parallel gegeben werden?",
                        answer: "Bitte konsultiere immer deinen Admin bevor du zus√§tzliche Medikamente gibst. Einige Antibiotika und andere Wirkstoffe k√∂nnen Wechselwirkungen haben."
                    },
                    {
                        question: "Was mache ich bei Nebenwirkungen oder Problemen?",
                        answer: "Kontaktiere sofort deinen Admin oder die Support Community. Bei anderen Medikamenten immer vorher nachfragen!"
                    },
                    {
                        question: "Wie oft muss ich meine Katze wiegen?",
                        answer: "Mindestens 1x w√∂chentlich wiegen und die Dosis neu berechnen. Bei Gewichtsabnahme die Dosis NICHT reduzieren!"
                    },
                    {
                        question: "Was passiert wenn ich eine Behandlung vergesse?",
                        answer: "Kontaktiere deinen Admin."
                    },
                    {
                        question: "Wie lange dauert die Behandlung?",
                        answer: "Die Standardbehandlung dauert 84 Tage. Diese Dauer sollte eingehalten werden, auch wenn die Katze sich besser f√ºhlt."
                    },
                    {
                        question: "Welche Begleitmedikamente sind sinnvoll?",
                        answer: "H√§ufig werden B12, Leberschutz und Omega-3 empfohlen. Besprich dies mit deinem Admin."
                    }
                ];

                return `
                    <div class="fixed inset-0 z-50 flex">
                        <div class="fixed inset-0 bg-black bg-opacity-30 transition-opacity" onclick="app.updateState('showFAQ', false)"></div>
                        <div class="ml-auto relative">
                            <div class="h-full w-screen max-w-md md:max-w-lg bg-white shadow-2xl transform transition-transform duration-300 ease-in-out flex flex-col overflow-hidden faq-sidebar faq-enter faq-enter-active" role="dialog" aria-labelledby="faq-title" aria-modal="true">
                                <div class="p-4 md:p-6 border-b border-gray-200 flex-shrink-0 bg-gradient-to-r from-blue-50 to-purple-50">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <svg class="text-blue-600 w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                            </svg>
                                            <h2 id="faq-title" class="text-xl md:text-2xl font-bold text-gray-800">FAQ</h2>
                                        </div>
                                        <button onclick="app.updateState('showFAQ', false)" onkeydown="if(event.key==='Escape') app.updateState('showFAQ', false)" class="text-gray-500 hover:text-gray-700 text-xl p-2 rounded-full hover:bg-gray-100 transition-colors">
                                            ‚úï
                                        </button>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1">H√§ufige Fragen zur Behandlung</p>
                                </div>
                                <div class="flex-1 overflow-y-auto p-4 md:p-6">
                                    <div class="space-y-6">
                                        ${faqs.map((faq, index) => `
                                            <div class="border-b border-gray-100 pb-4 last:border-b-0">
                                                <button onclick="app.toggleFAQ(${index})" class="w-full text-left focus:outline-none group">
                                                    <div class="flex justify-between items-start gap-3">
                                                        <h3 class="font-semibold text-gray-800 group-hover:text-blue-600 transition-colors">
                                                            ${faq.question}
                                                        </h3>
                                                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-600 transition-transform duration-200 flex-shrink-0 mt-0.5 ${this.state.openFAQ === index ? 'rotate-180' : ''}" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                                                        </svg>
                                                    </div>
                                                </button>
                                                <div class="mt-3 transition-all duration-200 overflow-hidden ${this.state.openFAQ === index ? 'max-h-96 opacity-100' : 'max-h-0 opacity-0'}">
                                                    <p class="text-gray-600 leading-relaxed pl-2 border-l-2 border-blue-100">
                                                        ${faq.answer}
                                                    </p>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                <div class="p-4 border-t border-gray-200 bg-gray-50 flex-shrink-0">
                                    <div class="text-center">
                                        <p class="text-xs text-gray-500">üí° Bei weiteren Fragen kontaktiere deinen Admin</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;
            }

            renderDemoOverlay() {
                if (!this.state.showDemoOverlay || !this.state.isDemo) return '';

                const currentStep = this.state.demoSteps[this.state.demoStep];

                return `
                    <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl max-w-md w-full p-6 relative">
                            <button onclick="app.exitDemo()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">‚úï</button>
                            <div class="text-center mb-4">
                                <div class="text-2xl mb-2">${currentStep.icon || 'üéØ'}</div>
                                <h3 class="text-xl font-semibold text-gray-800">${currentStep.title}</h3>
                                <p class="text-gray-600 mt-2">${currentStep.text}</p>
                            </div>
                            <div class="flex justify-between items-center mt-6">
                                <div class="text-sm text-gray-500">
                                    ${this.state.demoStep + 1} / ${this.state.demoSteps.length}
                                </div>
                                <div class="flex gap-2">
                                    ${this.state.demoStep > 0 ? `<button onclick="app.prevDemoStep()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Zur√ºck</button>` : ''}
                                    <button onclick="app.nextDemoStep()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                        ${this.state.demoStep === this.state.demoSteps.length - 1 ? 'Fertig' : 'Weiter'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;
            }

            highlightDemoTarget() {
                document.querySelectorAll('.demo-highlight').forEach(el => {
                    el.classList.remove('demo-highlight', 'ring-4', 'ring-blue-400', 'ring-opacity-75');
                });

                if (!this.state.showDemoOverlay || !this.state.isDemo) return;

                const currentStep = this.state.demoSteps[this.state.demoStep];
                const target = document.querySelector(`[data-demo="${currentStep.target}"]`);

                if (target) {
                    target.classList.add('demo-highlight', 'ring-4', 'ring-blue-400', 'ring-opacity-75');
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            renderSkeletonCat() {
                return `
                    <div class="cat-skeleton">
                        <div class="skeleton-circle"></div>
                        <div class="skeleton-body"></div>
                        <div class="skeleton-tail"></div>
                    </div>
                    ` : ''}
                `;
            }

            renderLoader() {
                if (!this.state.showLoader) return '';

                return `
                    <div class="cat-loader-overlay ${this.state.loadingComplete ? 'fade-out' : ''}">
                        <div class="cat">
                            <div class="cat__body cat-img-base"></div>
                            <div class="cat__body cat-img-base"></div>
                            <div class="cat__tail cat-img-base"></div>
                            <div class="cat__head cat-img-base"></div>
                        </div>
                        <h1 class="loader-title">Behandlungs-Tracker</h1>
                        <p class="loader-subtitle">Lade deine Katzen-Therapie App...</p>
                    </div>
                `;
            }

            getMilestoneCountdown(upcomingMilestone, today) {
                if (!upcomingMilestone) return null;
                const todayDate = new Date(today);
                const milestoneDate = new Date(upcomingMilestone.date);
                const diffTime = milestoneDate - todayDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            }

            getMotivationalMessage(completedCount, todayTreatment) {
                const messages = {
                    0: { icon: 'üåü', text: 'Der erste Schritt ist der wichtigste! Du schaffst das!', color: 'blue' },
                    7: { icon: 'üéØ', text: 'Eine Woche geschafft! Du und deine Katze seid ein tolles Team!', color: 'green' },
                    14: { icon: 'üí™', text: '2 Wochen durch! Jeder Tag bringt euch der Heilung n√§her!', color: 'green' },
                    21: { icon: 'üåà', text: '3 Wochen! Die Routine sitzt, ihr seid stark!', color: 'purple' },
                    28: { icon: 'ü©∏', text: 'Blutbild-Zeit! Ein wichtiger Meilenstein erreicht!', color: 'red' },
                    42: { icon: 'üöÄ', text: 'Halbzeit! 42 Tage geschafft - ihr seid Helden!', color: 'blue' },
                    56: { icon: 'üî•', text: '2 Monate durch! Das Schlimmste habt ihr hinter euch!', color: 'orange' },
                    70: { icon: 'üèîÔ∏è', text: 'Bergfest! Nur noch 2 Wochen bis zum Ziel!', color: 'indigo' },
                    77: { icon: 'üéâ', text: 'Fast geschafft! Das Ende ist in Sicht!', color: 'pink' },
                    84: { icon: 'üèÜ', text: 'GESCHAFFT! Ihr habt gemeinsam gek√§mpft und gewonnen!', color: 'yellow' }
                };

                const milestones = Object.keys(messages).map(Number).sort((a, b) => b - a);
                const currentMilestone = milestones.find(m => completedCount >= m) || 0;
                return messages[currentMilestone];
            }

            renderSupportMessage() {
                if (this.state.dismissedCards.support) return '';

                const hardDays = [10, 20, 30, 40, 50, 60];
                const currentDay = Object.values(this.state.treatmentData).filter(Boolean).length;

                if (hardDays.includes(currentDay)) {
                    return `
                      <div data-card-id="support" class="dismissible-card bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-4 group relative" role="button" tabindex="0" aria-label="Support Message - Klicken zum Ausblenden" onkeydown="if(event.key==='Enter'||event.key===' ') this.click()">
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-50 transition-all duration-200">
                          <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/>
                          </svg>
                        </div>
                        <div class="flex items-center gap-3">
                          <svg class="text-indigo-600 w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                          </svg>
                          <div>
                            <p class="font-medium text-indigo-800">
                              üíô Heute ist ein besonderer Tag - du hilfst deiner Katze zu heilen!
                            </p>
                            <p class="text-sm text-indigo-600 mt-1">
                              Es ist ok, wenn es manchmal schwer ist. Du machst das Richtige. üê±üíï
                            </p>
                          </div>
                        </div>
                      </div>
                    `;
                }
                return '';
            }

            getStreak() {
                if (!this.state.startDate) return 0;
                const today = new Date().toISOString().split('T')[0];
                let streak = 0;
                const startDate = new Date(this.state.startDate);

                for (let i = 0; i < 84; i++) {
                    const checkDate = new Date(startDate);
                    checkDate.setDate(startDate.getDate() + i);
                    const dateStr = checkDate.toISOString().split('T')[0];

                    if (checkDate > new Date(today)) break;

                    if (this.state.treatmentData[dateStr]) {
                        streak++;
                    } else {
                        streak = 0;
                    }
                }
                return streak;
            }

            launchConfetti(el) {
                const { left, top, width, height } = el.getBoundingClientRect();
                const x = (left + width / 2) / window.innerWidth;
                const y = (top + height / 2) / window.innerHeight;

                confetti({
                    particleCount: 100,
                    spread: 70,
                    startVelocity: 30,
                    angle: 90,
                    origin: { x, y },
                    disableForReducedMotion: true,
                });
            }

            dismissCard(id, el) {
                this.launchConfetti(el);
                this.state.dismissedCards[id] = true;
                this.render();
            }

            render() {
                const dailyDose = this.state.customDose ? parseFloat(this.state.customDose) : this.calculateDose();
                const treatmentDays = this.state.startDate ? this.generateTreatmentDays(this.state.startDate) : [];
                const completedCount = Object.values(this.state.treatmentData).filter(Boolean).length;
                const progressPercentage = treatmentDays.length > 0 ? (completedCount / 84) * 100 : 0;
                
                const today = new Date().toISOString().split('T')[0];
                const todayTreatment = treatmentDays.find(day => day.date === today);
                
                let todayStatus = null;
                if (todayTreatment) {
                    const now = new Date();
                    const [hours, minutes] = this.state.reminderTime.split(':');
                    const targetTime = new Date();
                    targetTime.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                    
                    todayStatus = {
                        ...todayTreatment,
                        isToday: true,
                        timeUntil: targetTime - now,
                        isPastTime: now >= targetTime
                    };
                }

                const upcomingMilestone = treatmentDays.find(day => day.date >= today && day.isMilestone);
                const motivationalMessage = this.getMotivationalMessage(completedCount, todayTreatment);
                const streak = this.getStreak();

                document.getElementById('app').innerHTML = `
                    ${this.renderLoader()}
                    ${this.state.showFAQ ? this.renderFAQ() : ''}
                    ${this.renderDemoOverlay()}

                    ${!this.state.showLoader ? `
                    <div class="max-w-4xl mx-auto p-4 md:p-6 bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
                        <div class="bg-white rounded-xl shadow-lg mobile-compact md:p-6 mb-6">
                            <div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                                <div class="flex items-center gap-3">
                                    <svg class="text-red-500 w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="m12 21.35-.5-.5c-6-5.5-10-9.17-10-13.65 0-3.3 2.69-6 6-6 2.14 0 4.16 1.08 5.26 2.86C13.84 4.08 15.86 3 18 3c3.31 0 6 2.7 6 6 0 4.48-4 8.15-10 13.65L12 21.35Z"/>
                                    </svg>
                                    <div>
                                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Behandlungs-Tracker</h1>
                                        <p class="text-sm text-gray-600">84 Tage Medikamenten-Therapie</p>
                                    </div>
                                </div>
                                
                                <div class="flex flex-wrap items-center gap-3">
                                    <div class="install-prompt items-center gap-2 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors cursor-pointer install-app-btn">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                                        </svg>
                                        <span>App installieren</span>
                                    </div>
                                    
                                    ${!this.state.startDate ? `
                                        <button onclick="app.startDemo()" class="flex items-center gap-2 px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                            Demo starten
                                        </button>
                                    ` : ''}
                                    
                                    <button onclick="app.updateState('showFAQ', true)" class="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                        </svg>
                                        FAQ
                                    </button>
                                </div>
                            </div>

                            ${!this.state.startDate && !this.state.isDemo ? `
                                <div class="space-y-6">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                        <div class="flex items-center gap-3 mb-4">
                                            <svg class="text-blue-600 w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/>
                                            </svg>
                                            <h2 class="text-xl font-semibold text-blue-800">Medikamenten-Dosisberechnung</h2>
                                        </div>
                                        
                                        <div class="mobile-grid md:grid-cols-2 gap-4 mb-4">
                                            <div class="col-span-full mb-4">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    üê± Name der Katze
                                                </label>
                                                <input data-demo="cat-name-input" type="text" value="${this.state.catName}"
                                                    onchange="app.updateState('catName', this.value)"
                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 mobile-input"
                                                    placeholder="z.B. Mimi">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    Gewicht der Katze (kg)
                                                </label>
                                                <input data-demo="weight-input" type="number" step="0.1" value="${this.state.catWeight}"
                                                    onchange="app.updateState('catWeight', this.value)"
                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 mobile-input" placeholder="z.B. 3.7">
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Behandlungsart</label>
                                                <select data-demo="fip-type-select" value="${this.state.fipType}" onchange="app.updateState('fipType', this.value)"
                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 mobile-input">
                                                    <option value="">W√§hlen...</option>
                                                    <option value="neuro" ${this.state.fipType === 'neuro' ? 'selected' : ''}>Neurologisch (10 mg/kg)</option>
                                                    <option value="ocular" ${this.state.fipType === 'ocular' ? 'selected' : ''}>Okul√§r (8 mg/kg)</option>
                                                    <option value="wet_dry" ${this.state.fipType === 'wet_dry' ? 'selected' : ''}>Standard (6 mg/kg)</option>
                                                </select>
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    Konzentration (mg/ml)
                                                </label>
                                                <input type="number" value="${this.state.concentration}" 
                                                    onchange="app.updateState('concentration', this.value)"
                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 mobile-input" placeholder="z.B. 16">
                                            </div>

                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-2">Startdatum</label>
                                                <input type="date" value="${this.state.startDate}" 
                                                    onchange="app.updateState('startDate', this.value)"
                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 mobile-input">
                                            </div>
                                        </div>

                                        ${dailyDose ? `
                                            <div data-demo="dose-display" class="bg-green-50 border border-green-200 rounded-lg p-4">
                                                <div class="flex items-center gap-3">
                                                    <svg class="text-green-600 w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                        <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                                                    </svg>
                                                    <div>
                                                        <p class="text-lg font-bold text-green-800">T√§gliche Dosis: ${dailyDose} ml</p>
                                                        <p class="text-sm text-gray-600">
                                                            ${this.state.catWeight} kg √ó ${this.state.fipType === 'neuro' ? '10' : this.state.fipType === 'ocular' ? '8' : '6'} mg/kg √∑ ${this.state.concentration} mg/ml = ${dailyDose} ml
                                                        </p>
                                                        <p class="text-xs text-gray-500 mt-1">üí° Automatisch auf 1 Nachkommastelle aufgerundet</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}

                            ${(this.state.startDate || this.state.isDemo) && dailyDose ? `
                                <!-- Weight & Dose Management -->
                                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                        <div class="flex flex-wrap items-center gap-4">
                                            <div class="flex items-center gap-2">
                                                <svg class="text-blue-600 w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M12 3c4.97 0 9 4.03 9 9s-4.03 9-9 9-9-4.03-9-9 4.03-9 9-9M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4m0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/>
                                                </svg>
                                                <span class="font-medium">Gewicht:</span>
                                                ${this.state.editingWeight ? `
                                                    <div class="flex items-center gap-2">
                                                        <input type="number" step="0.1" value="${this.state.catWeight}"
                                                            onchange="app.updateState('catWeight', this.value)"
                                                            class="w-20 border border-gray-300 rounded px-2 py-1 text-sm">
                                                        <button onclick="app.updateState('editingWeight', false)" class="text-green-600 hover:text-green-800">
                                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                                <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <div class="flex items-center gap-2">
                                                        <span class="font-bold">${this.state.catWeight} kg</span>
                                                        <button onclick="app.updateState('editingWeight', true)" class="text-blue-600 hover:text-blue-800">
                                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                                <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                `}
                                            </div>
                                            
                                            <div class="flex items-center gap-2">
                                                <svg class="text-green-600 w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                                                </svg>
                                                <span class="font-medium">Dosis:</span>
                                                <span class="font-bold text-green-700">${dailyDose} ml</span>
                                                ${this.state.customDose ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">Angepasst</span>' : ''}
                                            </div>
                                        </div>
                                        
                                        <div class="flex items-center gap-2">
                                            <input type="number" step="0.1" placeholder="Custom" value="${this.state.customDose}"
                                                onchange="app.updateState('customDose', this.value)"
                                                class="w-20 border border-gray-300 rounded px-2 py-1 text-sm">
                                            <span class="text-xs text-gray-500">ml</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Reminder Settings -->
                                <div data-demo="reminder-section" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                        <div class="flex items-center gap-3">
                                            <svg class="text-yellow-600 w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                                            </svg>
                                            <div>
                                                <h3 class="font-semibold">Erinnerungen</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${this.state.notificationsEnabled ? 'Aktiviert' : 'Benachrichtigungen aktivieren'}
                                                </p>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <input type="time" value="${this.state.reminderTime}" 
                                                onchange="app.updateState('reminderTime', this.value)"
                                                class="border border-gray-300 rounded px-2 py-1 text-sm mobile-input">
                                            ${!this.state.notificationsEnabled ? `
                                                <button onclick="app.enableNotifications()" class="px-3 py-1 bg-yellow-500 text-white rounded text-sm hover:bg-yellow-600 mobile-button">
                                                    Aktivieren
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>

                                <!-- Progress Overview -->
                                <div data-demo="progress-bar" class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-6 mb-6">
                                    <h2 class="text-xl font-semibold text-gray-800 mb-4">
                                        ${this.state.catName ? `${this.state.catName}s ` : ''}Behandlungsfortschritt
                                    </h2>
                                    
                                    <div class="flex items-center gap-4 mb-3">
                                        <div class="flex-1">
                                            <div class="bg-gray-200 rounded-full h-4">
                                                <div class="bg-gradient-to-r from-green-400 to-blue-500 h-4 rounded-full transition-all duration-500"
                                                    style="width: ${progressPercentage}%"></div>
                                            </div>
                                        </div>
                                        <span class="font-bold text-xl">${completedCount}/84</span>
                                    </div>
                                    
                                    <p class="text-sm text-gray-600 mb-3">
                                        ${Math.round(progressPercentage)}% abgeschlossen ‚Ä¢ ${84 - completedCount} Tage verbleibend
                                    </p>

                                    ${!this.state.dismissedCards.motivational ? `
                                    <div data-card-id="motivational" class="dismissible-card bg-gradient-to-r from-pink-50 to-purple-50 border border-pink-200 rounded-lg p-4 mb-6 group" role="button" tabindex="0" aria-label="Motivations-Karte - Klicken f√ºr Celebration" onkeydown="if(event.key==='Enter'||event.key===' ') this.click()">
                                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-60 transition-opacity duration-200 pointer-events-none">
                                            <div class="flex items-center gap-1 text-xs text-gray-500 bg-white bg-opacity-80 rounded-full px-2 py-1">
                                                <span>‚ú®</span>
                                                <span>Klicken</span>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="text-2xl">${motivationalMessage.icon}</div>
                                            <div class="flex-1">
                                                <p class="font-semibold text-${motivationalMessage.color}-800 mb-1">
                                                    ${motivationalMessage.text}
                                                </p>
                                                <p class="text-xs text-gray-600">
                                                    ‚ú® Jede Spritze ist ein Schritt zur Heilung ‚Ä¢ üíï Du rettest ein Leben ‚Ä¢ üî• Streak: ${streak} Tage
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    ` : ''}

                                    ${this.renderSupportMessage()}

                                    ${upcomingMilestone && !this.state.dismissedCards.milestone ? `
                                        <div data-card-id="milestone" class="dismissible-card bg-amber-50 border border-amber-200 rounded-lg p-3 group relative" role="button" tabindex="0" aria-label="Meilenstein-Karte - Klicken zum Ausblenden" onkeydown="if(event.key==='Enter'||event.key===' ') this.click()">
                                            <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-70 transition-opacity duration-200">
                                                <div class="text-xs bg-white bg-opacity-90 rounded-full w-6 h-6 flex items-center justify-center">
                                                    üéâ
                                                </div>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <svg class="text-amber-600 w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                                                </svg>
                                                <p class="text-sm font-medium text-amber-800">
                                                    N√§chster Meilenstein: ${upcomingMilestone.isMilestone.icon} ${upcomingMilestone.isMilestone.text}
                                                    <span class="font-bold">(Tag ${upcomingMilestone.day}, in ${this.getMilestoneCountdown(upcomingMilestone, today)} Tagen)</span>
                                                </p>
                                            </div>
                                        </div>
                                    ` : ''}

                                    ${!this.state.dismissedCards.healing ? `
                                    <div data-card-id="healing" class="dismissible-card bg-emerald-50 border border-emerald-200 rounded-lg p-3 mt-4 group relative" role="button" tabindex="0" aria-label="Heilungs-Karte - Klicken zum Ausblenden" onkeydown="if(event.key==='Enter'||event.key===' ') this.click()">
                                      <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-60 transition-opacity duration-200">
                                        <span class="text-sm">üíö</span>
                                      </div>
                                      <div class="text-center">
                                        <div class="text-emerald-700 text-sm font-medium mb-1">
                                          üíö Die Erkrankung ist heilbar!
                                        </div>
                                        <div class="text-xs text-emerald-600">
                                          84 Tage k√∂nnen das Leben deiner Katze retten ‚Ä¢ Durchhalteverm√∂gen wird belohnt
                                        </div>
                                      </div>
                                    </div>
                                    ` : ''}
                                </div>

                                ${todayStatus ? `
                                    <!-- Today's Status -->
                                    <div class="rounded-lg p-4 mb-6 ${
                                        todayStatus.completed 
                                            ? 'bg-green-50 border border-green-200' 
                                            : todayStatus.isMilestone
                                            ? 'bg-purple-50 border border-purple-200'
                                            : 'bg-yellow-50 border border-yellow-200'
                                    }">
                                        <div class="flex flex-col md:flex-row md:items-center justify-between mb-3 gap-4">
                                            <div class="flex items-center gap-3">
                                                <svg class="w-5 h-5 ${
                                                    todayStatus.completed ? 'text-green-600' : 
                                                    todayStatus.isMilestone ? 'text-purple-600' : 'text-yellow-600'
                                                }" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
                                                    <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
                                                </svg>
                                                <div>
                                                    <h3 class="font-semibold flex items-center gap-2">
                                                        ${this.state.catName ? `${this.state.catName} - ` : ''}Tag ${todayStatus.day}
                                                        ${todayStatus.isMilestone ? `<span class="text-lg">${todayStatus.isMilestone.icon}</span>` : ''}
                                                    </h3>
                                                    <p class="text-sm text-gray-600">
                                                        ${todayStatus.completed 
                                                            ? '‚úÖ Bereits behandelt!' 
                                                            : `‚è∞ ${this.formatTimeUntil(todayStatus.timeUntil)} ‚Ä¢ ${dailyDose} ml`
                                                        }
                                                    </p>
                                                    ${todayStatus.isMilestone ? `
                                                        <p class="text-xs font-medium text-purple-700 mt-1">
                                                            üéØ ${todayStatus.isMilestone.text}
                                                        </p>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            <button onclick="app.toggleTreatment('${todayStatus.date}')" class="px-4 py-2 rounded-md font-medium transition-colors mobile-button ${
                                                todayStatus.completed
                                                    ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                                    : 'bg-blue-500 text-white hover:bg-blue-600'
                                            }">
                                                ${todayStatus.completed ? 'R√ºckg√§ngig' : 'Behandelt!'}
                                            </button>
                                        </div>

                                        <!-- Today's Diary -->
                                        <div class="bg-white rounded-lg p-3 border">
                                            <div class="flex items-center gap-2 mb-2">
                                                <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                                                </svg>
                                                <span class="text-sm font-medium">Tagebuch heute:</span>
                                            </div>
                                            ${this.state.editingDiary === todayStatus.date ? `
                                                <div class="flex gap-2">
                                                    <textarea value="${this.state.diary[todayStatus.date] || ''}" 
                                                        onchange="app.updateDiary('${todayStatus.date}', this.value)"
                                                        placeholder="Wie geht es der Katze heute? Verhalten, Appetit, etc..."
                                                        class="flex-1 border border-gray-300 rounded px-3 py-2 text-sm mobile-input" rows="2"></textarea>
                                                    <button onclick="app.updateState('editingDiary', '')" class="px-3 py-2 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 mobile-button">
                                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                                            <path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/>
                                                        </svg>
                                                    </button>
                                                </div>
                                            ` : `
                                                <div onclick="app.updateState('editingDiary', '${todayStatus.date}')" 
                                                    class="text-sm text-gray-600 cursor-pointer hover:bg-gray-50 p-2 rounded">
                                                    ${this.state.diary[todayStatus.date] || 'Notiz hinzuf√ºgen... üìù'}
                                                </div>
                                            `}
                                        </div>
                                    </div>
                                ` : ''}

                                <!-- Treatment Calendar -->
                                <div class="bg-white rounded-lg border border-gray-200 p-4">
                                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Behandlungskalender</h2>
                                    <div data-demo="calendar-grid" class="grid grid-cols-5 sm:grid-cols-7 gap-2 max-h-96 overflow-y-auto">
                                        ${treatmentDays.map((day) => {
                                            const isToday = day.date === today;
                                            const isPast = day.dateObj < new Date();
                                            
                                            return `
                                                <button onclick="app.toggleTreatment('${day.date}')" class="p-2 md:p-3 rounded-lg border transition-all duration-200 relative text-xs ${
                                                    day.completed
                                                        ? 'bg-green-100 border-green-300 text-green-800'
                                                        : isToday
                                                        ? 'bg-yellow-100 border-yellow-300 text-yellow-800 ring-2 ring-yellow-400'
                                                        : day.isMilestone
                                                        ? 'bg-purple-100 border-purple-300 text-purple-800'
                                                        : isPast
                                                        ? 'bg-red-50 border-red-200 text-red-600'
                                                        : 'bg-gray-50 border-gray-200 text-gray-600 hover:bg-gray-100'
                                                }">
                                                    ${day.isMilestone ? `<div class="absolute -top-1 -right-1 text-xs">${day.isMilestone.icon}</div>` : ''}
                                                    ${this.state.diary[day.date] ? '<div class="absolute -top-1 -left-1 text-xs">üìù</div>' : ''}
                                                    <div class="flex items-center justify-center mb-1">
                                                        ${day.completed ? 
                                                            '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' :
                                                            '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/></svg>'
                                                        }
                                                    </div>
                                                    <div class="font-semibold">Tag ${day.day}</div>
                                                    <div class="text-xs">
                                                        ${day.dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' })}
                                                    </div>
                                                </button>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>

                                <!-- Important Reminders -->
                                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mt-6">
                                    <h3 class="font-semibold text-amber-800 mb-2">Wichtige Erinnerungen</h3>
                                    <ul class="text-sm text-amber-700 space-y-1">
                                        <li>‚Ä¢ T√§glich um ${this.state.reminderTime} (¬±30min fr√ºher, ¬±15min sp√§ter OK)</li>
                                        <li>‚Ä¢ W√∂chentlich wiegen & Dosis neu berechnen</li>
                                        <li>‚Ä¢ Injektionsstelle t√§glich wechseln (4 Stellen verf√ºgbar)</li>
                                        <li>‚Ä¢ Bei Gewichtsabnahme: Dosis NICHT reduzieren!</li>
                                        <li>‚Ä¢ Begleitmedikamente immer mit Admin absprechen</li>
                                    </ul>
                                </div>

                                <div class="mt-6 text-center">
                                    <button onclick="app.${this.state.isDemo ? 'exitDemo' : 'resetApp'}()" class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 underline">
                                        ${this.state.isDemo ? 'Demo beenden' : 'Behandlung zur√ºcksetzen'}
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ` : ''}
                `;
                setTimeout(() => this.highlightDemoTarget(), 50);
            }

            resetApp() {
                this.state.startDate = '';
                this.state.treatmentData = {};
                this.state.diary = {};
                this.state.catWeight = '';
                this.state.fipType = '';
                this.state.concentration = '';
                this.state.customDose = '';
                this.state.catName = '';
                
                // Clear all localStorage
                localStorage.removeItem('treatment-startDate');
                localStorage.removeItem('treatment-catWeight');
                localStorage.removeItem('treatment-catName');
                localStorage.removeItem('treatment-medicationType');
                localStorage.removeItem('treatment-concentration');
                localStorage.removeItem('treatment-customDose');
                localStorage.removeItem('treatment-reminderTime');
                localStorage.removeItem('treatment-progress');
                localStorage.removeItem('treatment-diary');

                this.state.dismissedCards = {};

                this.render();
            }
        }

        // Initialize app
        const app = new TreatmentTracker();
        const installer = new PWAInstaller();
        document.addEventListener('click', (e) => {
          if (e.target.closest('.install-app-btn')) {
            installer.installApp();
          }
          const card = e.target.closest('[data-card-id]');
          if (card) {
            const id = card.getAttribute('data-card-id');
            app.dismissCard(id, card);
          }
        });
    </script>

    <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }
    </script>
</body>
</html>
